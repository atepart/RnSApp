# RnSApp

Настольное приложение на PySide6 для расчёта и визуализации параметров ячеек (Rn/S), работы с шаблонами и выгрузками Excel. Поддерживает Windows и macOS, распространяется как готовые сборки и как исходники.

## Основные возможности
- Ввод/редактирование данных ячеек с расчётом Rn/S, подсветкой ошибок и быстрым пересчётом.
- Загрузка/сохранение таблиц в XLSX (см. `infrastructure/xlsx_io.py`), шаблоны для повторного использования (`infrastructure/template_io.py`).
- Графики на pyqtgraph (визуализация распределений/трендов).
- Гибкое восстановление расположения доков и сохранение состояния окна (QSettings).
- Проверка обновлений через GitHub Releases: список релизов берётся в фоне, подбирается ассет под текущую платформу; в UI выводится кликабельная ссылка и кнопка копирования.

## Запуск из исходников (dev)
1) Python 3.11+ и виртуальное окружение:
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   ```
2) Зависимости:
   ```bash
   pip install -r requirements.txt
   ```
3) Старт приложения:
   ```bash
   python main.py
   ```

### Быстрые клавиши и настройки
- Сохранение/восстановление положения окон и размеров: автоматически через QSettings.
- Сброс лэйаута доков — пункт меню «Вид».

## Сборка дистрибутива
- Windows: `build.bat` (PyInstaller, кладёт ресурсы в `dist/RnSApp`).
- macOS/Linux: `bash build.sh` (PyInstaller, создаёт `.app` или директорию в `dist`).
- Спецификация PyInstaller: `RnSApp.spec` (иконка, ресурсы `assets`).

### CI
`.github/workflows/build.yml` собирает:
- Windows: x86 и x64.
- macOS: arm64 (`macos-latest`) и x64 (`macos-15-intel`).
Артефакты публикуются в релиз GitHub по тегам.

## Обновления
- Список релизов берётся из репозитория `atepart/RnSApp` (см. `application/version.py:REPO_SLUG`).
- Архитектура определяется по `platform.machine()` с нормализацией: x64 ↔ (`x86_64`, `amd64`, `x64`), x86 ↔ (`i386`, `i686`, `x86`), arm64 ↔ (`arm64`, `aarch64`).
- При выборе релиза отображается ссылка: можно открыть в браузере или скопировать в буфер.

## Структура
- `application/` — версии, композиция зависимостей.
- `domain/` — модели/порты/константы.
- `infrastructure/` — Excel I/O, шаблоны, обновления, хранилища.
- `ui/` — главное окно, диалоги обновлений, виджеты, графики.

## Полезные переменные окружения
- `RNS_LOG_LEVEL` — уровень логирования (например, `DEBUG`).
- `GITHUB_TOKEN` / `GH_TOKEN` — токен для GitHub API, если требуется.

## Как пользоваться
1) **Ввод данных (таблица «Данные»)**  
   - Столбцы: `№`, `Имя`, чекбокс выбора, `Диаметр`, `Rₙ (Ω)`, `RnS`, `Ошибка RnS`, `Суммарный уход`, `Площадь`, `1/√Rₙ`.  
   - Для ввода нужны диаметр и Rₙ; чекбоксы автоматически проставятся при заполнении. Поддерживаются Copy/Paste из Excel.  
   - Параметры расчёта (Rn, допуск, заданные площади S2/S3) задаются в блоке «Действия» справа.
2) **Расчёт**  
   - Нажмите «Рассчитать» — таблица пересчитается, график обновится, ошибки RnS подсветятся. Пустые строки Rₙ автоматически снимаются с выбора перед расчётом.  
   - Средние RnS/уход отображаются над таблицей; сброс — «Очистить таблицы».
3) **Работа с 16 ячейками (блок «Запись»)**  
   - После расчёта нажмите «Записать» у нужной ячейки, задайте имя — RnS/Уход сохранятся в репозиторий и отобразятся под номером.  
   - Контекстное меню ячейки (ПКМ): «Показать данные» (загрузить сохранённые значения обратно в таблицы/график), «Переименовать», «Перезаписать».  
   - Чекбокс «Построить» добавляет/удаляет график по ячейке. Красная звёздочка рядом с номером — есть несохранённые изменения относительно записанных данных.
4) **Файлы и шаблоны**  
   - **XLSX**: «Открыть» — загрузить файл (текущие данные очищаются), «Сохранить» — экспорт текущей сетки и репозитория.  
   - **Шаблоны**: «Сохранить шаблон» — сохраняет заполненные строки (№/Имя/Диаметр/выбор) и заданные площади S2/S3; «Открыть шаблон» — загружает их в таблицу и в поля S2/S3.
5) **Графики**  
   - Обновляются после расчёта и при выборе ячеек (с чекбоксом «Построить»). Поддерживается зум/панорамирование мышью.  
   - Макет доков можно вернуть через меню «Вид» → «Сбросить макет».
6) **Проверка обновлений**  
   - Меню: «Проверить обновления». Релизы грузятся в фоне; для выбранного релиза показывается ссылка (кликабельна, есть кнопка «Скопировать»).

## Отладка проблем
- Включите `RNS_LOG_LEVEL=DEBUG` для подробных логов (HTTP, выбор ассетов).
- При ошибках проверки обновлений смотрите сообщения `UpdateError` (код/URL/текст ответа).
